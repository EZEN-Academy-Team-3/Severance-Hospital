<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./style.css" />
    <script
      src="https://kit.fontawesome.com/f0e73cfa04.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="bg"></div>
    <div id="blur"></div>
    <div id="header">
      <div id="profile">
        <img src="./img/profile_basic.jpg" alt="프로필이미지" />
      </div>
      <img id="logoimg" src="./img/spotify-logo.png" alt="logo" />
      <form class="search-bar">
        <button class="search-btn" type="submit">
          <i class="fas fa-search"></i>
        </button>
        <input class="search-bar__input" type="search" placeholder="Search" />
      </form>
    </div>
    <!-- x 버튼 -->
    <div class="esc">
      <input type="button" class="esc_btn">
    </div>

    <!-- 다음, 이전 동영상 버튼-->
    <div class="before">
      <input type="button" class="before_btn">
    </div>
    <div class="next">
      <input type="button" class="next_btn">
    </div>

    <div id="chart">
      <h1 id="charts_title">CHARTS</h1>
      <ul id="chart_ul">
        <!-- <li>
                <button class="musiccontainer pointer" >
                    <img class="albumart" src=""alt="" />
                    <h1 class="musicTitle">Music Title</h1>
                    <h4 class="singer">Singer</h4>
                    <span class='popularity'></span>
                </button>
            </li> -->
      </ul>
    </div>
    <!-- 유투브 재생할 div -->
    <div id="playercontainer">
        <!-- <div id="player" class='active'></div> -->
    </div>
    <footer>
      <address>copyright&copy;2022.Ezenac Team9</address>
    </footer>

    <script src="../node_modules/axios/dist/axios.min.js"></script>
    <script>
      const client_id = "2835661af65a4c8a9a1977d59e65f255";
      const client_pw = "06fc774a8d2f4995b4d0099166165aa8";
      const TOKEN_REQUEST_API = "https://accounts.spotify.com/api/token";
      const auth = btoa(`${client_id}:${client_pw}`);
      let Top_Trackjson;
      // 재검색 할 경우 기존화면 삭제를 위한 변수설정
      const resultReset = 1;

      //토큰을 가져오는 함수
      (async function get_token() {
        try {
          const res = await axios.post(
            "https://accounts.spotify.com/api/token",
            "grant_type=client_credentials",
            {
              headers: {
                Authorization: "Basic " + auth,
                "Content-Type": "application/x-www-form-urlencoded",
              },
            }
          );

          window.localStorage.setItem("token", res.data.access_token);
        } catch (e) {
          console.error(e);
          return;
        }
      })();

      //해당 가수를 spotify에서 서치하는 이벤트
      document.querySelector(".search-bar").addEventListener("submit", (e) => {
        e.preventDefault();

        // 리셋을 위해 기존 검색결과가 생성될 위치의 부모요소 선택
        const list = document.querySelector("#chart_ul");

        const query = document.querySelector(".search-bar__input");
        queryKeyword = query.value.trim(); //앞뒤 공백을 제외한 검색어

        if (!queryKeyword) {
          //검색어가 없다면
          alert("검색어를 입력하세요.");
          queryField.focus();
          return;
        }

        // 기존에 표시되고 있던 검색결과가 있다면 삭제한다.
        if (resultReset == 1) {
          Array.from(list.getElementsByTagName("li")).forEach((v, i) => {
            list.removeChild(v);
          });
        }

        //뒤로가기 
        const state = {queryKeyword: queryKeyword};
        const url = `${location.pathname}?queryKeyword=${queryKeyword}`;
        history.pushState(state, null, url);

        console.log("검색어 = ", queryKeyword);
        spotify_search(queryKeyword);
      });

      //스포티파이 검색 함수
      async function spotify_search(queryKeyword) {
        const token = window.localStorage.getItem("token");

        const q = "" + queryKeyword;

        try{

          const res = await axios.get(`https://api.spotify.com/v1/search`, {
            params: {
              q: q,
              type: "artist",
            },
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          console.log(res.data);
          console.log("spotify에서 가져온 id =", res.data.artists.items[0].id);
  
          //서치한 가수의 top track 가져오는 함수
          const id = res.data.artists.items[0].id;
          const res2 = await axios.get(
            `https://api.spotify.com/v1/artists/${id}/top-tracks`,
            {
              params: {
                market: "ES",
              },
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          console.log(res2.data);

          

          //이미 출력되고 있는 항목이 있다면 삭제
          Array.from(chart_ul.getElementsByTagName('li')).map((v,i)=>{
            chart_ul.removeChild(v);
          });
  
          //singer 가수 배열
          Top_Trackjson = res2.data.tracks;
          const singerArr = [];
          const music_Title_Arr = [];
          console.log(Top_Trackjson);
  
          //li 태그 생성
          if (Top_Trackjson) {
            Top_Trackjson.forEach((v, i) => {
              //list 생성
              const ul = document.querySelector("#chart_ul");
              const li = document.createElement("li");
              const button = document.createElement("button");
              const img = document.createElement("img");
              const h1 = document.createElement("h1");
              const h4 = document.createElement("h4");
              // 하트, 인기도 감쌀 부모요소 div
              const div = document.createElement("div");
              const h5 = document.createElement("h5");
              const img2 = document.createElement("img");
  
              ul.appendChild(li);
              li.appendChild(button);
              button.appendChild(img);
              button.appendChild(h1);
              button.appendChild(h4);
              // button 안에 div생성 및 자식요소로 하트, 인기도 넣기
              button.appendChild(div);              
              div.appendChild(img2);
              div.appendChild(h5);                
  
              button.classList.add("musiccontainer");
              button.classList.add("pointer");
              img.classList.add("albumart");
              h1.classList.add("musicTitle");
              h4.classList.add("singer");
              // div 및 하부요소들에 class 부여
              div.classList.add("h_pop")
              img2.classList.add("heart");
              h5.classList.add("popularity");
  
              h1.innerHTML = v.name;
              h4.innerHTML = v.artists[0].name;
              img.setAttribute("src", v.album.images[0].url);
              // 하트, 인기도 
              img2.setAttribute("src", "https://www.freeiconspng.com/uploads/heart-png-8.png" );
              h5.innerHTML = v.popularity;
            });
          }


          // 검색결과가 없을떄를 위한 catch 부분
        }catch(error){
          const ul = document.querySelector("#chart_ul");
          const li = document.createElement("li");
          const a = document.createElement("a");
          const h1 = document.createElement("h1");

          ul.appendChild(li);
          li.appendChild(a);
          a.appendChild(h1);

      
          h1.classList.add('musicTitle_error');
          h1.innerHTML = "검색결과가 없습니다."
        }

        //각 musiccontainer에 클릭이벤트
        document.querySelectorAll(".musiccontainer").forEach((v, i) => {
          let count = i;
          v.addEventListener("click", (e) => {
            e.preventDefault();

            /* 현재 선택한 음원 */
            const music_Title = e.currentTarget.children[2].innerHTML+' '+e.currentTarget.children[1].innerHTML;
            console.log(music_Title);

            /* 전체 트랙 리스트 가져오는 변수 선정 */
            const total_Music = e.currentTarget.parentElement.parentElement;
            console.log(total_Music);

            /* 카운터의 값에 따라 달라지는 트랙 리스트 */

            const total_Track = total_Music.children[count].querySelector(".musiccontainer");
            console.log(total_Track);
            /* 이전 음원 */

            const before_Track = total_Track.children[2].innerHTML + ' ' + total_Track.children[1].innerHTML;
            
            /* 다음 음원 */

            const next_Track = total_Track.children[2].innerHTML + ' ' + total_Track.children[1].innerHTML;

            onYouTubeIframeAPIReady(music_Title);
            
            document.querySelector('.esc').style.display="block";
            document.querySelector('.before').style.display="block";
            document.querySelector('.next').style.display="block";

            
         
            // 이전 동영상 재생 --------------------------
            /* 검색한 키워드의 트랙 정보를 가져온뒤 현재 클릭이벤트 발생중인 박스 곡의 인덱스-1한 값을 가져와 유튜브에 연결 **/
            document.querySelector(".before").addEventListener("click", (e) => {
              e.preventDefault();
              count -= 1;
              console.log(count);

              onYouTubeIframeAPIReady(before_Track);
            });

            // 다음 동영상 재생 --------------------------
            /* 검색한 키워드의 트랙 정보를 가져온뒤 현재 클릭이벤트 발생중인 박스 곡의 인덱스-1한 값을 가져와 유튜브에 연결 **/
            document.querySelector(".next").addEventListener("click", (e) => {
              e.preventDefault();
              count += 1;
              console.log(count);

              onYouTubeIframeAPIReady(next_Track);
            });

          });
        });
      }

      //영상을 나타내는 코드
      //Iframe Player API를 비동기적으로 로드한다.
      var tag = document.createElement("script");

      tag.src = "https://www.youtube.com/iframe_api"; 
      var firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      //API 코드를 다운로드 받은 다음 <iframe>을 생성
      var player;
      async function onYouTubeIframeAPIReady(music_Title, before_Track, next_Track) {

          const API_key = "AIzaSyB_TDbk3nTC8kMFG17awyA3khUagnNNMec";
          let json = null;
          const q = music_Title + " MV";

        if(music_Title){
            try {
              json = await axios.get(
                `https://www.googleapis.com/youtube/v3/search`,
                {
                  params: {
                    key: API_key,
                    q: q,
                    part: "snippet",
                    type: "video",
                    maxResults: 1,
                  },
                }
              );
            } catch (e) {
              console.error("[Error Code]", error.code);
              console.error("[Error Message]", error.message);
            }
            const data = json.data;
            console.log(data);
    
            const id = data.items[0].id.videoId;
            console.log(id);

            
            const div = document.createElement("div");
            const container = document.querySelector('#playercontainer');
            
            Array.from(container.children).forEach(function(child) {
                container.removeChild(child);
            });

            container.appendChild(div);
            div.setAttribute('id','player');

                player = new YT.Player("player", {
                height: "720", //영상 높이
                width: "1280", //영상 너비
                videoId: '' + id,
                playerVars: {
                    rel: 0, //연관동영상 표시여부(0:표시안함)
                    controls: 1, //플레이어 컨트롤러 표시여부(0:표시안함)
                    autoplay: 1, //자동재생 여부(1:자동재생 함, mute와 함께 설정)
                    // mute: 1, //음소거여부(1:음소거 함)
                    loop: 1, //반복재생여부(1:반복재생 함)
                },
                events: {
                    onReady: onPlayerReady, //onReady 상태일 때 작동하는 function이름
                    onStateChange: onPlayerStateChange, //onStateChange 상태일 때 작동하는 function이름
                },
                });

                document.querySelector("#blur").style.display="block"
        }

      }

      // 4. API는 비디오 플레이어가 준비되면 아래의 function을 불러올 것이다.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

      // 5. API는 플레이어의 상태가 변화될 때 아래의 function을 불러올 것이다.
      //    이 function은 비디오가 재생되고 있을 때를 가르킨다.(state=1),
      var done = false;
      function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !done) {
          setTimeout(stopVideo, 0);
          done = true;
        }
      }
      function stopVideo() {
        player.stopVideo();
      }      
      
      //esc 버튼 눌렀을 때
      document.querySelector(".esc").addEventListener("click", e=>{
        document.querySelector('.esc').style.display="none";
        document.querySelector('.before').style.display="none";
        document.querySelector('.next').style.display="none";
        document.querySelector('#player').remove();
        document.querySelector('#blur').style.display="none";
      });

      /**history가 이전 페이지로 되돌아 갈 때 발생하는 이벤트*/
      window.addEventListener('popstate', (e)=>{
        console.group("back");
        console.log(e.state);
        if(e.state){
          const queryKeyword = e.state.queryKeyword;
          spotify_search(queryKeyword);
        }else{
          Array.from(chart_ul.getElementsByTagName('li')).map((v,i)=>{
            chart_ul.removeChild(v);
          })
        }
        console.groupEnd();
       });
    </script>
  </body>
</html>
